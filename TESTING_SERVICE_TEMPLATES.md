## Тестирование универсальной системы сервисов

Документ описывает, как проверить новые возможности шаблонов сервисов, динамических полей и универсальной CRM-формы без правок кода.

### 1. Предварительные шаги
- Убедитесь, что база данных обновлена миграцией `backend/migrations/010_create_service_field_templates.sql`.  
  ```bash
  cd /home/whoami/prj/MyCloudapp
  mysql -u <DB_USER> -p <DB_NAME> < backend/migrations/010_create_service_field_templates.sql
  ```
- Перезапустите backend:
  ```bash
  cd backend
  npm install   # при необходимости
  npm start
  ```
- В отдельном окне запустите CRM:
  ```bash
  cd /home/whoami/prj/MyCloudapp/crm-mobile-web
  npm install   # при необходимости
  npm run dev   # или npm run build для прод-режима
  ```

### 2. Базовый сценарий (создание нового типа сервиса)
1. Откройте CRM → раздел «Управление сервисами».
2. Нажмите «Добавить группу» и создайте новую группу, напр. `Видеонаблюдение` (slug `video_surveillance`).
3. Выберите созданную группу и добавьте шаблоны полей:
   - `tariff` (Текст, обязательное)
   - `resolution` (Select: `720p|HD`, `1080p|Full HD`, `4k|4K`)
   - `bandwidth` (Text)
   - `archive_storage` (Text, обязательное)
   - `camera_storage` (Text)
   - `disk_space` (Number, единица измерения «GB»)
   - `pvz_kit` (Boolean)
   - `price_monthly` (Price, обязательное)
   - `price_yearly` (Price)
4. Нажмите «+ Новый план», заполните общие поля (название, описание, стоимость, период, статус, домен/заметки) и значения для каждого шаблонного поля.
5. Сохраните план и убедитесь, что он отображается в списке планов группы.

### 3. Проверка динамических полей
1. Откройте созданный план (кнопка «Редактировать»).
2. Убедитесь, что все значения шаблонов подставились в форму.
3. Измените, например, `price_yearly`, сохраните и убедитесь, что изменения отображаются в списке.
4. Добавьте кастомное поле (кнопка «+ Свое поле») и сохраните — поле должно появиться только в этом плане.

### 4. Проверка обязательных полей
1. Попробуйте сохранить план, очистив значение любого обязательного поля (например, `tariff`).  
2. CRM должно показать предупреждение «Заполните обязательные поля …» и не дать сохранить план.

### 5. Проверка пользовательского приложения
1. Авторизуйтесь в мобильном/веб-клиенте (папка `app/` или Expo).
2. Откройте группу сервисов, которую создали.  
3. Убедитесь, что тариф отображает все параметры (включая новые поля) и цены.
4. Перейдите в процесс оформления (checkout) и проверьте, что выбранный план передаёт правильные значения.

### 6. Тестирование других типов сервисов
- Повторите шаги 2–5 для типов «VPS», «SSL», «Хостинг» или любого нового.  
- Для VPS добавьте поля `cpu`, `ram`, `disk`, `ip_count`, `os`, `bandwidth`, `price`.

### 7. API-проверки (опционально)
Используйте Postman или curl:
```bash
curl -H "Authorization: Bearer <token>" https://<host>/api/service-groups
curl -H "Authorization: Bearer <token>" "https://<host>/api/service-plans?group_id=<id>"
curl -H "Authorization: Bearer <token>" https://<host>/api/service-plans/<plan_id>
```
Проверьте, что в ответе поля `fields` содержат `definition_id`, `template.label_ru`, `field_value_ru` и т.д.

### 8. Масштабное тестирование
- **Нагрузочное**: создайте 3–5 групп (например, VPS, Видео, DNS, SSL, SaaS), каждая с 5–10 шаблонами полей и 10+ планами. Проверяйте, что страница CRM не тормозит, а API выдаёт данные корректно.
- **Регрессивное**: убедитесь, что старые VPS-планы продолжают отображаться после миграции (их поля должны появляться как “кастомные”, если нет шаблонов).
- **Удаление**: удалите один шаблон поля и убедитесь, что существующие планы теряют ссылку на шаблон, но сохраняют значения (поля остаются как кастомные). Затем создайте новый шаблон и снова привяжите поле, проверив, что всё сохраняется.

### 9. Чек-лист перед релизом
- [ ] Миграция применена без ошибок.
- [ ] CRUD операций с группами, шаблонами и планами проходят успешно.
- [ ] Формы валидируют обязательные поля.
- [ ] Пользовательское приложение корректно отображает новые поля и цены.
- [ ] Интеграции (оплата, заказы) используют `service_plan_id` и не зависят от конкретного типа сервиса.
- [ ] Логи сервера не содержат SQL/валидационных ошибок.

Следуя этому документу, можно полноценно протестировать новые гибкие сервисы и убедиться, что администраторы управляют типами услуг без изменения кода.

